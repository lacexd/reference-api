"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const chai_1 = require("chai");
const agent_1 = require("../../app/agent");
const creation_1 = require("../fixtures/creation");
const updates_1 = require("../fixtures/updates");
describe("MongooseAdapter", () => {
    let Agent;
    before(() => {
        return agent_1.default.then((A) => { Agent = A; });
    });
    describe("Fetching", () => {
        it("should show virtuals in the response", () => {
            return Agent.request("GET", "/organizations")
                .then(resp => {
                chai_1.expect(resp.body.data.every(resource => resource.attributes.virtualName.endsWith(' (virtualized)'))).to.be.true;
            });
        });
        it("should support sorting by valid geoDistance, iff no other sorts are provided", () => {
            return Promise.all([
                Agent.request("GET", "/organizations?sort=(location,geoDistance,[-70,40])")
                    .then(resp => {
                    const resources = resp.body.data;
                    const stateGovIndex = resources.findIndex(it => it.id === "54419d550a5069a2129ef254");
                    const echoOrgIndex = resources.findIndex(it => it.id === "59ac9c0ecc4c356fcda65202");
                    chai_1.expect(stateGovIndex < echoOrgIndex).to.be.true;
                }),
                Agent.request("GET", "/organizations?sort=(location,geoDistance,[0,0])")
                    .then(resp => {
                    const resources = resp.body.data;
                    const stateGovIndex = resources.findIndex(it => it.id === "54419d550a5069a2129ef254");
                    const echoOrgIndex = resources.findIndex(it => it.id === "59ac9c0ecc4c356fcda65202");
                    chai_1.expect(echoOrgIndex < stateGovIndex).to.be.true;
                }),
                Agent.request("GET", "/organizations?sort=name,(location,geoDistance,[0,0])")
                    .catch(e => {
                    chai_1.expect(e.response.status).to.equal(400);
                    chai_1.expect(e.response.body.errors[0].detail).to.equal("Cannot combine geoDistance sorts with other sorts.");
                })
            ]);
        });
        it("should exclude documents with no geo field when \"sorting\" by distance", () => {
            return Agent.request("GET", "/organizations?sort=(location,geoDistance,[-70,40])")
                .then(resp => {
                chai_1.expect(resp.body.data.filter(it => it.id === "59af14d3bbd18cd55ea08ea3")).to.have.length(0);
            });
        });
        it("should support pagination with sorting by geoDistance", () => {
            return Promise.all([
                Agent.request("GET", "/organizations?sort=(location,geoDistance,[-70,40])&page[limit]=1")
                    .then(resp => {
                    const resources = resp.body.data;
                    chai_1.expect(resources.length).to.equal(1);
                    chai_1.expect(resources[0].id).to.equal("54419d550a5069a2129ef254");
                }),
                Agent.request("GET", "/organizations?sort=(location,geoDistance,[-70,40])&page[limit]=1&page[offset]=1")
                    .then(resp => {
                    const resources = resp.body.data;
                    chai_1.expect(resources.length).to.equal(1);
                    chai_1.expect(resources[0].id).to.equal("59ac9c0ecc4c356fcda65202");
                })
            ]);
        });
    });
    describe.skip("Deletion", () => { });
    describe("Creation", () => {
        let createdResource;
        before(() => {
            return Agent.request("POST", "/organizations")
                .type("application/vnd.api+json")
                .send({ "data": creation_1.VALID_ORG_RESOURCE_NO_ID })
                .then((response) => {
                createdResource = response.body.data;
            }, (e) => {
                console.log(e, e.response.body);
            });
        });
        it("should run setters on create", () => {
            chai_1.expect(createdResource.attributes.name).to.equal(creation_1.VALID_ORG_RESOURCE_NO_ID.attributes.name.toUpperCase());
            chai_1.expect(createdResource.attributes.echo).to.equal(creation_1.VALID_ORG_RESOURCE_NO_ID.attributes.echo);
        });
        it("should show virtuals in the returned resource", () => {
            chai_1.expect(createdResource.attributes.virtualName).to.equal(creation_1.VALID_ORG_RESOURCE_NO_ID.attributes.name.toUpperCase() + ' (virtualized)');
            chai_1.expect(createdResource.attributes.reversed).to.equal(creation_1.VALID_ORG_RESOURCE_NO_ID.attributes.echo.split("").reverse().join(""));
        });
        it("should apply schema defaults", () => {
            chai_1.expect(createdResource.attributes.neverSet).to.equal("set from mongoose default");
        });
        it("should not allow setting internal fields as attributes", () => {
            const makeSetInternalFieldRequest = (k, v, inRelationships) => {
                const spreadData = inRelationships
                    ? {
                        relationships: Object.assign({}, creation_1.VALID_ORG_RESOURCE_NO_ID.relationships, { [k]: { data: v } })
                    }
                    : {
                        attributes: Object.assign({}, creation_1.VALID_ORG_RESOURCE_NO_ID.attributes, { [k]: v })
                    };
                return Agent.request("POST", "/organizations")
                    .type("application/vnd.api+json")
                    .send({ "data": Object.assign({}, creation_1.VALID_ORG_RESOURCE_NO_ID, spreadData) })
                    .then((response) => {
                    throw new Error("Should not run!");
                }, (e) => {
                    chai_1.expect(e.status).to.equal(400);
                    chai_1.expect([
                        "https://jsonapi.js.org/errors/illegal-field-name",
                        "https://jsonapi.js.org/errors/invalid-linkage-json"
                    ]).to.include(e.response.body.errors[0].code);
                });
            };
            return Promise.all([
                makeSetInternalFieldRequest("__t", "School", false),
                makeSetInternalFieldRequest("__v", 3, false),
                makeSetInternalFieldRequest("__t", "School", true),
                makeSetInternalFieldRequest("__v", 3, true),
                makeSetInternalFieldRequest("__t", { "type": "organizations", id: "School" }, true),
                makeSetInternalFieldRequest("__v", { "type": "organizations", id: 3 }, true),
            ]);
        });
    });
    describe("Updating", () => {
        let res;
        before(() => {
            return Agent.request("PATCH", `/organizations/${updates_1.VALID_ORG_VIRTUAL_PATCH.id}`)
                .type("application/vnd.api+json")
                .send({ "data": updates_1.VALID_ORG_VIRTUAL_PATCH })
                .then((response) => {
                res = response.body.data;
            });
        });
        it("should invoke setters on virtual, updated attributes", () => {
            chai_1.expect(res.attributes.echo).to.be.equal(updates_1.VALID_ORG_VIRTUAL_PATCH.attributes.echo);
            chai_1.expect(res.attributes.reversed).to.be.equal(updates_1.VALID_ORG_VIRTUAL_PATCH.attributes.echo.split("").reverse().join(""));
        });
        it("should invoke setters on non-virtual updated attributes", () => {
            chai_1.expect(res.attributes.name).to.equal("CHANGED NAME");
        });
        it("should not allow setting internal fields", () => {
            const makeSetInternalFieldRequest = (k, v, inRelationships) => {
                const spreadData = inRelationships
                    ? {
                        relationships: Object.assign({}, creation_1.VALID_ORG_RESOURCE_NO_ID.relationships, { [k]: { data: v } })
                    }
                    : {
                        attributes: Object.assign({}, creation_1.VALID_ORG_RESOURCE_NO_ID.attributes, { [k]: v })
                    };
                return Agent.request("PATCH", `/organizations/${updates_1.VALID_ORG_VIRTUAL_PATCH.id}`)
                    .type("application/vnd.api+json")
                    .send({
                    "data": Object.assign({ type: "organizations", id: updates_1.VALID_ORG_VIRTUAL_PATCH.id }, spreadData)
                })
                    .then((response) => {
                    throw new Error("Should not run!");
                }, (e) => {
                    chai_1.expect(e.status).to.equal(400);
                    chai_1.expect([
                        "https://jsonapi.js.org/errors/illegal-field-name",
                        "https://jsonapi.js.org/errors/invalid-linkage-json"
                    ]).to.include(e.response.body.errors[0].code);
                });
            };
            return Promise.all([
                makeSetInternalFieldRequest("__t", "School", false),
                makeSetInternalFieldRequest("__v", 3, false),
                makeSetInternalFieldRequest("__t", "School", true),
                makeSetInternalFieldRequest("__v", 3, true),
                makeSetInternalFieldRequest("__t", { "type": "organizations", id: "School" }, true),
                makeSetInternalFieldRequest("__v", { "type": "organizations", id: 3 }, true),
            ]);
        });
    });
});
